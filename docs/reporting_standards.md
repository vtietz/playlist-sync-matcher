# Reporting Table Standards

This document defines the standardized table structure, column ordering, badge system, and linking conventions for all HTML/CSV reports generated by PSM.

## Design Principles

1. **Remove Internal IDs**: Never show database `track_id`, `file_id`, or similar internal identifiers
2. **Provider Linking**: All entities (track, artist, album, playlist) should link to the streaming provider (currently Spotify)
3. **Consistent Column Order**: Follow standardized patterns across all report types
4. **Status at End**: All status badges and metadata columns appear at the end
5. **Duration Consistency**: Always show music duration in MM:SS format
6. **Shortened Paths**: Show relative or basename paths instead of full absolute paths

## Standardized Column Order

### Music Entity Columns (Left Side)
1. **Track** - Track name with provider link
2. **Artist** - Artist name with provider link (if available)
3. **Album** - Album name with provider link (if available) 
4. **Duration** - Track duration in MM:SS format
5. **Year** - Release year (if available)

### File/Match Context (Middle)
6. **File** - Shortened file path (relative or basename)
7. **Local Title** - Title from file metadata (if different from track)
8. **Local Artist** - Artist from file metadata (if different from track)
9. **Local Album** - Album from file metadata (if different from track)
10. **Local Duration** - File duration in MM:SS format (if different from track)

### Metadata/Status (Right Side)
11. **Playlists** - Number of playlists containing this track
12. **Score** - Match confidence score (if applicable)
13. **Status** - Status badge (Confidence, Quality, etc.) - ALWAYS LAST

## Badge System

### Colors & Hierarchy
```css
/* Status Priority (Green = Best, Red = Worst) */
.badge-success    { background: #28a745; color: white; }  /* CERTAIN, COMPLETE, EXCELLENT */
.badge-primary    { background: #007bff; color: white; }  /* HIGH, GOOD */
.badge-warning    { background: #ffc107; color: #212529; } /* MEDIUM, PARTIAL */
.badge-danger     { background: #dc3545; color: white; }  /* LOW, MISSING, POOR */
.badge-secondary  { background: #6c757d; color: white; }  /* UNKNOWN, N/A */
```

### Badge Types by Report

**Match Confidence:**
- ðŸŸ¢ CERTAIN (badge-success)
- ðŸ”µ HIGH (badge-primary)  
- ðŸŸ¡ MEDIUM (badge-warning)
- ðŸ”´ LOW (badge-danger)
- âš« UNKNOWN (badge-secondary)

**Quality Status:**
- ðŸŸ¢ EXCELLENT (badge-success) - All metadata present
- ðŸ”µ GOOD (badge-primary) - Minor missing fields
- ðŸŸ¡ PARTIAL (badge-warning) - Some metadata missing
- ðŸ”´ POOR (badge-danger) - Major metadata missing

**Completeness:**
- ðŸŸ¢ COMPLETE (badge-success) - 100% matched
- ðŸ”µ HIGH (badge-primary) - 80-99% matched
- ðŸŸ¡ PARTIAL (badge-warning) - 50-79% matched
- ðŸ”´ LOW (badge-danger) - <50% matched

## Link Generation

### Track Links
```html
<a href="https://open.spotify.com/track/{track_id}" target="_blank" 
   title="Open in Spotify">{track_name}</a>
```

### Artist Links
```html
<a href="https://open.spotify.com/artist/{artist_id}" target="_blank" 
   title="Open in Spotify">{artist_name}</a>
```

### Album Links  
```html
<a href="https://open.spotify.com/album/{album_id}" target="_blank" 
   title="Open in Spotify">{album_name}</a>
```

### Playlist Links
```html
<a href="https://open.spotify.com/playlist/{playlist_id}" target="_blank" 
   title="Open in Spotify">{playlist_name}</a>
```

## Path Shortening

### Strategy
1. **Relative to project root**: `music/folder/song.mp3` instead of `C:\Users\...\music\folder\song.mp3`
2. **Common prefix removal**: If all paths share a common prefix, remove it
3. **Basename fallback**: For very long paths, show just the filename with tooltip for full path

### Implementation
```python
def shorten_path(full_path: str, base_dir: str = None, max_length: int = 60) -> str:
    """Shorten file path for display."""
    path = Path(full_path)
    
    # Try relative to base_dir
    if base_dir:
        try:
            relative = path.relative_to(base_dir)
            if len(str(relative)) <= max_length:
                return str(relative)
        except ValueError:
            pass
    
    # Fallback to basename if path is too long
    if len(str(path)) > max_length:
        return path.name
    
    return str(path)
```

## Duration Formatting

### Format: MM:SS
```python
def format_duration(duration_ms: int = None, duration_sec: float = None) -> str:
    """Format duration as MM:SS."""
    if duration_ms is not None:
        seconds = duration_ms // 1000
    elif duration_sec is not None:
        seconds = int(duration_sec)
    else:
        return ""
    
    minutes = seconds // 60
    seconds = seconds % 60
    return f"{minutes}:{seconds:02d}"
```

## Report Type Specifications

### Matched Tracks Report
**Columns:**
1. Track (linked)
2. Artist (linked) 
3. Album (linked)
4. Duration
5. Year
6. File (shortened)
7. Local Title
8. Local Artist  
9. Local Album
10. Local Duration
11. Score
12. Status (Confidence badge)

### Unmatched Tracks Report
**Columns:**
1. Track (linked)
2. Artist (linked)
3. Album (linked) 
4. Duration
5. Year
6. Playlists
7. Status (Priority badge based on playlist count)

### Unmatched Albums Report
**Columns:**
1. Artist (linked)
2. Album (linked)
3. Year
4. Track Count
5. Playlists
6. Status (Completeness badge)

### Playlist Coverage Report
**Columns:**
1. Playlist (linked)
2. Owner
3. Total Tracks
4. Matched
5. Missing
6. Status (Coverage percentage badge)

### Metadata Quality Report
**Columns:**
1. File (shortened)
2. Title
3. Artist  
4. Album
5. Year
6. Duration
7. Bitrate
8. Status (Quality badge)

## CSS Classes

### Required Badge Classes
```css
.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    text-align: center;
    white-space: nowrap;
}

.badge-success { background: #28a745; color: white; }
.badge-primary { background: #007bff; color: white; }
.badge-warning { background: #ffc107; color: #212529; }
.badge-danger { background: #dc3545; color: white; }
.badge-secondary { background: #6c757d; color: white; }
```

### Link Styling
```css
a {
    color: #007bff;
    text-decoration: none;
    transition: color 0.2s ease;
}

a:hover {
    color: #0056b3;
    text-decoration: underline;
}
```

### Path Shortening with Tooltips
```css
.path-short {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: help;
}
```

## Migration Notes

### Current Issues to Fix
1. **Remove Spotify ID columns** - Replace with linked track names
2. **Add duration columns** - Extract from `tracks.duration_ms` and `library_files.duration`
3. **Implement path shortening** - Apply to all file path displays
4. **Standardize badge placement** - Move all status badges to final column
5. **Add entity linking** - Enable artist and album links (requires ID fetching)

### Database Enhancements Needed
To support full entity linking, we may need to store additional IDs:
- `tracks.artist_id` - Spotify artist ID
- `tracks.album_id` - Spotify album ID  
- Fetch these during playlist ingestion if not already available